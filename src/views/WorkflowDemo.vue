<template>
  <div class="workflow-demo">
    <el-card>
      <template #header>
        <h2>å·¥ä½œæµå’Œå®¡æ‰¹ç³»ç»Ÿæ¼”ç¤º</h2>
      </template>

      <div class="demo-content">
        <div class="feature-intro">
          <h3>ğŸš€ é«˜çº§å·¥ä½œæµå’Œå®¡æ‰¹åŠŸèƒ½</h3>
          <p>æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å·¥ä½œæµç®¡ç†å’Œå®¡æ‰¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
        </div>

        <!-- åŠŸèƒ½ç‰¹æ€§å±•ç¤º -->
        <el-row :gutter="20" class="features-grid">
          <el-col :span="12">
            <div class="feature-card">
              <div class="feature-icon">
                <el-icon><Rank /></el-icon>
              </div>
              <div class="feature-content">
                <h4>å¤šçº§å®¡æ‰¹æµç¨‹</h4>
                <ul>
                  <li>æ”¯æŒé¡ºåºã€å¹¶è¡Œã€æ¡ä»¶å®¡æ‰¹</li>
                  <li>çµæ´»çš„å®¡æ‰¹æ­¥éª¤é…ç½®</li>
                  <li>è‡ªå®šä¹‰å®¡æ‰¹è§’è‰²å’Œæƒé™</li>
                  <li>åŠ¨æ€çš„å®¡æ‰¹è·¯å¾„è°ƒæ•´</li>
                </ul>
              </div>
            </div>
          </el-col>

          <el-col :span="12">
            <div class="feature-card">
              <div class="feature-icon">
                <el-icon><Timer /></el-icon>
              </div>
              <div class="feature-content">
                <h4>å®¡æ‰¹æ—¶é—´é™åˆ¶</h4>
                <ul>
                  <li>è®¾ç½®æ¯ä¸ªæ­¥éª¤çš„æ—¶é—´é™åˆ¶</li>
                  <li>è‡ªåŠ¨è¶…æ—¶æ£€æµ‹å’Œå¤„ç†</li>
                  <li>æ”¯æŒè‡ªåŠ¨æ‰¹å‡†æˆ–å‡çº§å¤„ç†</li>
                  <li>é€šçŸ¥æé†’æœºåˆ¶</li>
                </ul>
              </div>
            </div>
          </el-col>

          <el-col :span="12">
            <div class="feature-card">
              <div class="feature-icon">
                <el-icon><Switch /></el-icon>
              </div>
              <div class="feature-content">
                <h4>å®¡æ‰¹å§”æ‰˜åŠŸèƒ½</h4>
                <ul>
                  <li>ä¸´æ—¶å§”æ‰˜å®¡æ‰¹æƒé™</li>
                  <li>è®¾ç½®å§”æ‰˜æœ‰æ•ˆæœŸ</li>
                  <li>æ”¯æŒç‰¹å®šå·¥ä½œæµå§”æ‰˜</li>
                  <li>å§”æ‰˜çŠ¶æ€ç®¡ç†</li>
                </ul>
              </div>
            </div>
          </el-col>

          <el-col :span="12">
            <div class="feature-card">
              <div class="feature-icon">
                <el-icon><DocumentIcon /></el-icon>
              </div>
              <div class="feature-content">
                <h4>å·¥ä½œæµæ¨¡æ¿ç®¡ç†</h4>
                <ul>
                  <li>åˆ›å»ºå¯å¤ç”¨çš„å·¥ä½œæµæ¨¡æ¿</li>
                  <li>æ¨¡æ¿åˆ†ç±»å’Œå¤æ‚åº¦æ ‡è®°</li>
                  <li>åŸºäºæ¨¡æ¿å¿«é€Ÿåˆ›å»ºå·¥ä½œæµ</li>
                  <li>æ¨¡æ¿ä½¿ç”¨ç»Ÿè®¡</li>
                </ul>
              </div>
            </div>
          </el-col>
        </el-row>

        <!-- å¿«é€Ÿè®¿é—®æŒ‰é’® -->
        <div class="quick-actions">
          <h3>å¿«é€Ÿä½“éªŒ</h3>
          <div class="action-buttons">
            <el-button
              type="primary"
              size="large"
              @click="$router.push('/dashboard/workflows')"
            >
              <el-icon><Setting /></el-icon>
              å·¥ä½œæµç®¡ç†
            </el-button>

            <el-button
              type="success"
              size="large"
              @click="$router.push('/dashboard/review')"
            >
              <el-icon><View /></el-icon>
              å®¡æ‰¹ä¸­å¿ƒ
            </el-button>

            <el-button size="large" @click="createSampleWorkflow">
              <el-icon><Plus /></el-icon>
              åˆ›å»ºç¤ºä¾‹å·¥ä½œæµ
            </el-button>

            <el-button size="large" @click="createSampleDelegation">
              <el-icon><Switch /></el-icon>
              åˆ›å»ºç¤ºä¾‹å§”æ‰˜
            </el-button>
          </div>
        </div>

        <!-- ä½¿ç”¨æŒ‡å— -->
        <div class="usage-guide">
          <h3>ä½¿ç”¨æŒ‡å—</h3>
          <el-steps :active="0" direction="vertical">
            <el-step
              title="åˆ›å»ºå·¥ä½œæµ"
              description="åœ¨å·¥ä½œæµç®¡ç†é¡µé¢åˆ›å»ºæ–°çš„å®¡æ‰¹æµç¨‹ï¼Œé…ç½®å®¡æ‰¹æ­¥éª¤å’Œè§„åˆ™"
            />
            <el-step
              title="è®¾ç½®å®¡æ‰¹æƒé™"
              description="ä¸ºæ¯ä¸ªæ­¥éª¤åˆ†é…å®¡æ‰¹è§’è‰²ï¼Œè®¾ç½®æ—¶é—´é™åˆ¶å’Œå…¶ä»–å‚æ•°"
            />
            <el-step
              title="å¯åŠ¨å®¡æ‰¹æµç¨‹"
              description="æäº¤æ–‡æ¡£æˆ–ä¸“åˆ©ç”³è¯·ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¯åŠ¨ç›¸åº”çš„å®¡æ‰¹æµç¨‹"
            />
            <el-step
              title="å¤„ç†å®¡æ‰¹ä»»åŠ¡"
              description="å®¡æ‰¹äººå‘˜åœ¨å®¡æ‰¹ä¸­å¿ƒæŸ¥çœ‹å’Œå¤„ç†å¾…å®¡æ‰¹ä»»åŠ¡"
            />
            <el-step
              title="ç›‘æ§å’Œç®¡ç†"
              description="ç®¡ç†å‘˜å¯ä»¥ç›‘æ§æµç¨‹è¿›åº¦ï¼Œå¤„ç†è¶…æ—¶å’Œå¼‚å¸¸æƒ…å†µ"
            />
          </el-steps>
        </div>

        <!-- æŠ€æœ¯ç‰¹ç‚¹ -->
        <div class="tech-features">
          <h3>æŠ€æœ¯ç‰¹ç‚¹</h3>
          <el-row :gutter="20">
            <el-col :span="8">
              <div class="tech-item">
                <el-icon class="tech-icon"><DataLine /></el-icon>
                <h5>ç±»å‹å®‰å…¨</h5>
                <p>ä½¿ç”¨TypeScriptç¡®ä¿ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯</p>
              </div>
            </el-col>

            <el-col :span="8">
              <div class="tech-item">
                <el-icon class="tech-icon"><Monitor /></el-icon>
                <h5>å“åº”å¼è®¾è®¡</h5>
                <p>åŸºäºVue 3 Composition APIçš„å“åº”å¼çŠ¶æ€ç®¡ç†</p>
              </div>
            </el-col>

            <el-col :span="8">
              <div class="tech-item">
                <el-icon class="tech-icon"><Grid /></el-icon>
                <h5>æ¨¡å—åŒ–æ¶æ„</h5>
                <p>æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•</p>
              </div>
            </el-col>
          </el-row>
        </div>
      </div>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { useDocumentStore } from "@/stores/document";
import { useUserStore } from "@/stores/user";
import { ElMessage } from "element-plus";
import {
  Rank,
  Timer,
  Switch,
  Document as DocumentIcon,
  Setting,
  View,
  Plus,
  DataLine,
  Monitor,
  Grid,
} from "@element-plus/icons-vue";

// Store
const documentStore = useDocumentStore();
const userStore = useUserStore();

// æ–¹æ³•
const createSampleWorkflow = async () => {
  try {
    const sampleWorkflow = {
      name: "ç¤ºä¾‹ä¸“åˆ©å®¡æ‰¹æµç¨‹",
      description: "è¿™æ˜¯ä¸€ä¸ªç”¨äºæ¼”ç¤ºçš„ä¸“åˆ©å®¡æ‰¹å·¥ä½œæµ",
      type: "sequential" as const,
      priority: "medium" as const,
      category: "ä¸“åˆ©",
      version: "1.0",
      steps: [
        {
          id: "step-1-preliminary-review",
          stepNumber: 1,
          name: "åˆæ­¥å®¡æŸ¥",
          description: "å¯¹ä¸“åˆ©ç”³è¯·è¿›è¡Œåˆæ­¥å½¢å¼å®¡æŸ¥",
          approverRoles: ["reviewer"],
          isRequired: true,
          allowParallel: false,
          timeLimit: 24,
          minApprovals: 1,
          autoApprove: false,
          delegationAllowed: true,
        },
        {
          id: "step-2-technical-review",
          stepNumber: 2,
          name: "æŠ€æœ¯å®¡æŸ¥",
          description: "å¯¹ä¸“åˆ©æŠ€æœ¯å†…å®¹è¿›è¡Œè¯¦ç»†å®¡æŸ¥",
          approverRoles: ["reviewer"],
          isRequired: true,
          allowParallel: false,
          timeLimit: 72,
          minApprovals: 1,
          autoApprove: false,
          delegationAllowed: true,
        },
        {
          id: "step-3-final-approval",
          stepNumber: 3,
          name: "æœ€ç»ˆå®¡æ‰¹",
          description: "ç®¡ç†å‘˜è¿›è¡Œæœ€ç»ˆå®¡æ‰¹å†³å®š",
          approverRoles: ["admin"],
          isRequired: true,
          allowParallel: false,
          timeLimit: 48,
          minApprovals: 1,
          autoApprove: false,
          delegationAllowed: false,
        },
      ],
      isActive: true,
      createdBy: userStore.currentUser?.id || 1,
      tags: ["ç¤ºä¾‹", "ä¸“åˆ©", "æ¼”ç¤º"],
    };

    await documentStore.createApprovalWorkflow(sampleWorkflow);
    ElMessage.success("ç¤ºä¾‹å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼");
  } catch (error) {
    ElMessage.error("åˆ›å»ºå¤±è´¥: " + (error as Error).message);
  }
};

const createSampleDelegation = async () => {
  try {
    const currentUser = userStore.currentUser;
    if (!currentUser) {
      ElMessage.warning("è¯·å…ˆç™»å½•");
      return;
    }

    // æŸ¥æ‰¾ä¸€ä¸ªå¯ä»¥å§”æ‰˜çš„ç”¨æˆ·
    const availableUsers = userStore.users.filter(
      (u) =>
        u.id !== currentUser.id && (u.role === "admin" || u.role === "reviewer")
    );

    if (availableUsers.length === 0) {
      ElMessage.warning("æ²¡æœ‰å¯å§”æ‰˜çš„ç”¨æˆ·");
      return;
    }

    const delegateeUser = availableUsers[0];
    const now = new Date();
    const endDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7å¤©å

    const sampleDelegation = {
      delegatorId: currentUser.id,
      delegatorName: currentUser.realName,
      delegateeId: delegateeUser.id,
      delegateeName: delegateeUser.realName,
      startDate: now.toISOString(),
      endDate: endDate.toISOString(),
      reason: "å‡ºå·®æœŸé—´ä¸´æ—¶å§”æ‰˜å®¡æ‰¹æƒé™",
      isActive: true,
    };

    await documentStore.createDelegation(sampleDelegation);
    ElMessage.success("ç¤ºä¾‹å§”æ‰˜åˆ›å»ºæˆåŠŸï¼");
  } catch (error) {
    ElMessage.error("åˆ›å»ºå¤±è´¥: " + (error as Error).message);
  }
};
</script>

<style scoped>
.workflow-demo {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.demo-content {
  padding: 20px;
}

.feature-intro {
  text-align: center;
  margin-bottom: 40px;
}

.feature-intro h3 {
  color: #2c3e50;
  font-size: 2em;
  margin-bottom: 16px;
}

.feature-intro p {
  color: #666;
  font-size: 1.1em;
  line-height: 1.6;
}

.features-grid {
  margin-bottom: 40px;
}

.feature-card {
  display: flex;
  padding: 24px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  transition: transform 0.3s ease;
}

.feature-card:hover {
  transform: translateY(-4px);
}

.feature-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 24px;
  margin-right: 20px;
  flex-shrink: 0;
}

.feature-content h4 {
  margin: 0 0 12px 0;
  color: #2c3e50;
  font-size: 1.3em;
}

.feature-content ul {
  margin: 0;
  padding-left: 20px;
  color: #666;
}

.feature-content li {
  margin-bottom: 6px;
  line-height: 1.5;
}

.quick-actions {
  text-align: center;
  margin: 40px 0;
  padding: 30px;
  background: rgba(64, 158, 255, 0.05);
  border-radius: 12px;
  border: 1px solid rgba(64, 158, 255, 0.2);
}

.quick-actions h3 {
  margin: 0 0 24px 0;
  color: #409eff;
  font-size: 1.5em;
}

.action-buttons {
  display: flex;
  gap: 16px;
  justify-content: center;
  flex-wrap: wrap;
}

.usage-guide {
  margin: 40px 0;
  padding: 30px;
  background: #f8f9fa;
  border-radius: 12px;
}

.usage-guide h3 {
  margin: 0 0 24px 0;
  color: #2c3e50;
  font-size: 1.5em;
}

.tech-features {
  margin: 40px 0;
}

.tech-features h3 {
  margin: 0 0 24px 0;
  color: #2c3e50;
  font-size: 1.5em;
  text-align: center;
}

.tech-item {
  text-align: center;
  padding: 20px;
}

.tech-icon {
  font-size: 2.5em;
  color: #409eff;
  margin-bottom: 12px;
}

.tech-item h5 {
  margin: 0 0 8px 0;
  color: #2c3e50;
  font-size: 1.2em;
}

.tech-item p {
  margin: 0;
  color: #666;
  line-height: 1.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .workflow-demo {
    padding: 10px;
  }

  .demo-content {
    padding: 10px;
  }

  .feature-card {
    flex-direction: column;
    text-align: center;
  }

  .feature-icon {
    margin-right: 0;
    margin-bottom: 16px;
  }

  .action-buttons {
    flex-direction: column;
    align-items: center;
  }

  .action-buttons .el-button {
    width: 100%;
    max-width: 300px;
  }
}
</style>
