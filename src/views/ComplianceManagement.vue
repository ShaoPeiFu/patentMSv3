<template>
  <div class="compliance-container">
    <el-card class="compliance-card">
      <template #header>
        <div class="card-header">
          <h2>üìã ÂêàËßÑÁÆ°ÁêÜ</h2>
          <p class="subtitle">Ê≥ïËßÑË∑üË∏™„ÄÅÂêàËßÑÊ£ÄÊü•„ÄÅÂÆ°ËÆ°ÁóïËøπ‰∏éÈöêÁßÅ‰øùÊä§</p>
        </div>
      </template>

      <!-- ÂêàËßÑÊ¶ÇËßà -->
      <el-row :gutter="20" class="overview-section">
        <el-col :span="6">
          <el-card class="overview-card">
            <div class="overview-content">
              <div class="overview-icon regulations">
                <el-icon><Document /></el-icon>
              </div>
              <div class="overview-info">
                <h3>{{ overview.totalRegulations }}</h3>
                <p>Ë∑üË∏™Ê≥ïËßÑ</p>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="overview-card">
            <div class="overview-content">
              <div class="overview-icon checklist">
                <el-icon><Check /></el-icon>
              </div>
              <div class="overview-info">
                <h3>{{ overview.completedChecks }}</h3>
                <p>Â∑≤ÂÆåÊàêÊ£ÄÊü•</p>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="overview-card">
            <div class="overview-content">
              <div class="overview-icon audit">
                <el-icon><Monitor /></el-icon>
              </div>
              <div class="overview-info">
                <h3>{{ overview.auditTrails }}</h3>
                <p>ÂÆ°ËÆ°ÁóïËøπ</p>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="overview-card">
            <div class="overview-content">
              <div class="overview-icon privacy">
                <el-icon><Lock /></el-icon>
              </div>
              <div class="overview-info">
                <h3>{{ overview.privacyIncidents }}</h3>
                <p>ÈöêÁßÅ‰∫ã‰ª∂</p>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>

      <!-- ÂäüËÉΩÊ®°Âùó -->
      <el-row :gutter="20" class="modules-section">
        <el-col :span="12">
          <el-card class="module-card">
            <template #header>
              <div class="module-header">
                <el-icon><Document /></el-icon>
                <span>Ê≥ïËßÑÂèòÊõ¥Ë∑üË∏™</span>
                <el-button
                  type="primary"
                  size="small"
                  @click="addRegulation"
                  style="margin-left: auto"
                >
                  <el-icon><Plus /></el-icon>
                  Ê∑ªÂä†Ê≥ïËßÑ
                </el-button>
              </div>
            </template>
            <div class="module-content">
              <el-table
                :data="regulations"
                style="width: 100%"
                max-height="300"
              >
                <el-table-column prop="name" label="Ê≥ïËßÑÂêçÁß∞" />
                <el-table-column prop="version" label="ÁâàÊú¨" width="80" />
                <el-table-column
                  prop="updateDate"
                  label="Êõ¥Êñ∞Êó•Êúü"
                  width="120"
                />
                <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100">
                  <template #default="scope">
                    <el-tag :type="getRegulationStatusType(scope.row.status)">
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="Êìç‰Ωú" width="150">
                  <template #default="scope">
                    <el-button size="small" @click="viewRegulation(scope.row)">
                      Êü•Áúã
                    </el-button>
                    <el-button
                      size="small"
                      type="warning"
                      @click="editRegulation(scope.row)"
                    >
                      ÁºñËæë
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>
              <div class="module-actions">
                <el-button @click="refreshRegulations">
                  <el-icon><Refresh /></el-icon>
                  Âà∑Êñ∞
                </el-button>
                <el-button @click="exportRegulations">
                  <el-icon><Download /></el-icon>
                  ÂØºÂá∫
                </el-button>
              </div>
            </div>
          </el-card>
        </el-col>

        <el-col :span="12">
          <el-card class="module-card">
            <template #header>
              <div class="module-header">
                <el-icon><Check /></el-icon>
                <span>ÂêàËßÑÊ£ÄÊü•Ê∏ÖÂçï</span>
                <el-button
                  type="primary"
                  size="small"
                  @click="addChecklist"
                  style="margin-left: auto"
                >
                  <el-icon><Plus /></el-icon>
                  Ê∑ªÂä†Ê£ÄÊü•È°π
                </el-button>
              </div>
            </template>
            <div class="module-content">
              <el-table :data="checklists" style="width: 100%" max-height="300">
                <el-table-column prop="name" label="Ê£ÄÊü•È°πÁõÆ" />
                <el-table-column prop="category" label="Á±ªÂà´" width="100" />
                <el-table-column prop="dueDate" label="Êà™Ê≠¢Êó•Êúü" width="120" />
                <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100">
                  <template #default="scope">
                    <el-tag :type="getChecklistStatusType(scope.row.status)">
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="Êìç‰Ωú" width="150">
                  <template #default="scope">
                    <el-button size="small" @click="viewChecklist(scope.row)">
                      Êü•Áúã
                    </el-button>
                    <el-button
                      size="small"
                      type="warning"
                      @click="editChecklist(scope.row)"
                    >
                      ÁºñËæë
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>
              <div class="module-actions">
                <el-button @click="refreshChecklists">
                  <el-icon><Refresh /></el-icon>
                  Âà∑Êñ∞
                </el-button>
                <el-button @click="exportChecklists">
                  <el-icon><Download /></el-icon>
                  ÂØºÂá∫
                </el-button>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>

      <el-row :gutter="20" class="modules-section">
        <el-col :span="12">
          <el-card class="module-card">
            <template #header>
              <div class="module-header">
                <el-icon><Monitor /></el-icon>
                <span>ÂÆ°ËÆ°ÁóïËøπ</span>
                <el-button
                  type="primary"
                  size="small"
                  @click="exportAuditTrails"
                  style="margin-left: auto"
                >
                  <el-icon><Download /></el-icon>
                  ÂØºÂá∫Êó•Âøó
                </el-button>
              </div>
            </template>
            <div class="module-content">
              <el-table
                :data="auditTrails"
                style="width: 100%"
                max-height="300"
              >
                <el-table-column prop="timestamp" label="Êó∂Èó¥" width="150" />
                <el-table-column prop="user" label="Áî®Êà∑" width="100" />
                <el-table-column prop="action" label="Êìç‰Ωú" />
                <el-table-column prop="resource" label="ËµÑÊ∫ê" width="120" />
                <el-table-column prop="result" label="ÁªìÊûú" width="80">
                  <template #default="scope">
                    <el-tag
                      :type="scope.row.result === 'ÊàêÂäü' ? 'success' : 'danger'"
                      size="small"
                    >
                      {{ scope.row.result }}
                    </el-tag>
                  </template>
                </el-table-column>
              </el-table>
              <div class="module-actions">
                <el-button @click="refreshAuditTrails">
                  <el-icon><Refresh /></el-icon>
                  Âà∑Êñ∞
                </el-button>
                <el-button @click="clearAuditTrails">
                  <el-icon><Delete /></el-icon>
                  Ê∏ÖÁ©∫
                </el-button>
              </div>
            </div>
          </el-card>
        </el-col>

        <el-col :span="12">
          <el-card class="module-card">
            <template #header>
              <div class="module-header">
                <el-icon><Lock /></el-icon>
                <span>Êï∞ÊçÆÈöêÁßÅ‰øùÊä§</span>
                <el-button
                  type="primary"
                  size="small"
                  @click="addPrivacyEvent"
                  style="margin-left: auto"
                >
                  <el-icon><Plus /></el-icon>
                  Ê∑ªÂä†‰∫ã‰ª∂
                </el-button>
              </div>
            </template>
            <div class="module-content">
              <el-table
                :data="privacyEvents"
                style="width: 100%"
                max-height="300"
              >
                <el-table-column prop="timestamp" label="Êó∂Èó¥" width="150" />
                <el-table-column prop="type" label="Á±ªÂûã" width="100" />
                <el-table-column prop="description" label="ÊèèËø∞" />
                <el-table-column prop="severity" label="‰∏•ÈáçÁ®ãÂ∫¶" width="100">
                  <template #default="scope">
                    <el-tag
                      :type="getSeverityType(scope.row.severity)"
                      size="small"
                    >
                      {{ scope.row.severity }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="status" label="Áä∂ÊÄÅ" width="80">
                  <template #default="scope">
                    <el-tag
                      :type="
                        scope.row.status === 'Â∑≤Â§ÑÁêÜ' ? 'success' : 'warning'
                      "
                      size="small"
                    >
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
              </el-table>
              <div class="module-actions">
                <el-button @click="refreshPrivacyEvents">
                  <el-icon><Refresh /></el-icon>
                  Âà∑Êñ∞
                </el-button>
                <el-button @click="exportPrivacyEvents">
                  <el-icon><Download /></el-icon>
                  ÂØºÂá∫
                </el-button>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>

      <!-- ÂêàËßÑÊä•Âëä -->
      <el-card class="report-card">
        <template #header>
          <div class="report-header">
            <h3>ÂêàËßÑÊä•Âëä</h3>
            <div class="report-actions">
              <el-button type="primary" @click="generateReport">
                <el-icon><Document /></el-icon>
                ÁîüÊàêÊä•Âëä
              </el-button>
              <el-button @click="exportReport">
                <el-icon><Download /></el-icon>
                ÂØºÂá∫Êä•Âëä
              </el-button>
            </div>
          </div>
        </template>
        <div class="report-content">
          <el-row :gutter="20">
            <el-col :span="8">
              <div class="report-item">
                <h4>Ê≥ïËßÑÂêàËßÑÁéá</h4>
                <div class="progress-container">
                  <el-progress
                    :percentage="complianceRate.regulations"
                    :color="getProgressColor(complianceRate.regulations)"
                  />
                  <span>{{ complianceRate.regulations }}%</span>
                </div>
              </div>
            </el-col>
            <el-col :span="8">
              <div class="report-item">
                <h4>Ê£ÄÊü•ÂÆåÊàêÁéá</h4>
                <div class="progress-container">
                  <el-progress
                    :percentage="complianceRate.checklists"
                    :color="getProgressColor(complianceRate.checklists)"
                  />
                  <span>{{ complianceRate.checklists }}%</span>
                </div>
              </div>
            </el-col>
            <el-col :span="8">
              <div class="report-item">
                <h4>ÈöêÁßÅ‰øùÊä§Áéá</h4>
                <div class="progress-container">
                  <el-progress
                    :percentage="complianceRate.privacy"
                    :color="getProgressColor(complianceRate.privacy)"
                  />
                  <span>{{ complianceRate.privacy }}%</span>
                </div>
              </div>
            </el-col>
          </el-row>
        </div>
      </el-card>
    </el-card>

    <!-- Ê≥ïËßÑËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="showRegulationDialog" title="Ê≥ïËßÑËØ¶ÊÉÖ" width="60%">
      <div v-if="selectedRegulation" class="regulation-detail">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="Ê≥ïËßÑÂêçÁß∞">{{
            selectedRegulation.name
          }}</el-descriptions-item>
          <el-descriptions-item label="ÁâàÊú¨">{{
            selectedRegulation.version
          }}</el-descriptions-item>
          <el-descriptions-item label="ÂèëÂ∏ÉÊó•Êúü">{{
            selectedRegulation.publishDate
          }}</el-descriptions-item>
          <el-descriptions-item label="ÁîüÊïàÊó•Êúü">{{
            selectedRegulation.effectiveDate
          }}</el-descriptions-item>
          <el-descriptions-item label="Áä∂ÊÄÅ">{{
            selectedRegulation.status
          }}</el-descriptions-item>
          <el-descriptions-item label="ÈÄÇÁî®ËåÉÂõ¥">{{
            selectedRegulation.scope
          }}</el-descriptions-item>
        </el-descriptions>

        <div class="regulation-content">
          <h4>Ê≥ïËßÑÂÜÖÂÆπ</h4>
          <p>{{ selectedRegulation.content }}</p>
        </div>

        <div class="regulation-requirements">
          <h4>ÂêàËßÑË¶ÅÊ±Ç</h4>
          <el-tag
            v-for="req in selectedRegulation.requirements"
            :key="req"
            style="margin-right: 8px; margin-bottom: 8px"
          >
            {{ req }}
          </el-tag>
        </div>
      </div>
    </el-dialog>

    <!-- Ê£ÄÊü•Ê∏ÖÂçïËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="showChecklistDialog" title="Ê£ÄÊü•Ê∏ÖÂçïËØ¶ÊÉÖ" width="60%">
      <div v-if="selectedChecklist" class="checklist-detail">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="Ê£ÄÊü•È°πÁõÆ">{{
            selectedChecklist.name
          }}</el-descriptions-item>
          <el-descriptions-item label="Á±ªÂà´">{{
            selectedChecklist.category
          }}</el-descriptions-item>
          <el-descriptions-item label="Êà™Ê≠¢Êó•Êúü">{{
            selectedChecklist.dueDate
          }}</el-descriptions-item>
          <el-descriptions-item label="Ë¥üË¥£‰∫∫">{{
            selectedChecklist.assignee
          }}</el-descriptions-item>
          <el-descriptions-item label="Áä∂ÊÄÅ">{{
            selectedChecklist.status
          }}</el-descriptions-item>
          <el-descriptions-item label="‰ºòÂÖàÁ∫ß">{{
            selectedChecklist.priority
          }}</el-descriptions-item>
        </el-descriptions>

        <div class="checklist-content">
          <h4>Ê£ÄÊü•ÂÜÖÂÆπ</h4>
          <p>{{ selectedChecklist.description }}</p>
        </div>

        <div class="checklist-items">
          <h4>Ê£ÄÊü•È°πÁõÆ</h4>
          <el-checkbox-group v-model="selectedChecklist.completedItems">
            <el-checkbox
              v-for="item in selectedChecklist.items"
              :key="item.id"
              :label="item.id"
            >
              {{ item.description }}
            </el-checkbox>
          </el-checkbox-group>
        </div>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showChecklistDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveChecklist">‰øùÂ≠ò</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- Ê∑ªÂä†/ÁºñËæëÊ≥ïËßÑÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showRegulationFormDialog"
      :title="isEditingRegulation ? 'ÁºñËæëÊ≥ïËßÑ' : 'Ê∑ªÂä†Ê≥ïËßÑ'"
      width="60%"
    >
      <el-form
        :model="regulationForm"
        :rules="regulationRules"
        ref="regulationFormRef"
        label-width="100px"
      >
        <el-form-item label="Ê≥ïËßÑÂêçÁß∞" prop="name">
          <el-input
            v-model="regulationForm.name"
            placeholder="ËØ∑ËæìÂÖ•Ê≥ïËßÑÂêçÁß∞"
          />
        </el-form-item>
        <el-form-item label="ÁâàÊú¨" prop="version">
          <el-input
            v-model="regulationForm.version"
            placeholder="ËØ∑ËæìÂÖ•ÁâàÊú¨Âè∑"
          />
        </el-form-item>
        <el-form-item label="ÂèëÂ∏ÉÊó•Êúü" prop="publishDate">
          <el-date-picker
            v-model="regulationForm.publishDate"
            type="date"
            placeholder="ÈÄâÊã©ÂèëÂ∏ÉÊó•Êúü"
          />
        </el-form-item>
        <el-form-item label="ÁîüÊïàÊó•Êúü" prop="effectiveDate">
          <el-date-picker
            v-model="regulationForm.effectiveDate"
            type="date"
            placeholder="ÈÄâÊã©ÁîüÊïàÊó•Êúü"
          />
        </el-form-item>
        <el-form-item label="Áä∂ÊÄÅ" prop="status">
          <el-select v-model="regulationForm.status" placeholder="ÈÄâÊã©Áä∂ÊÄÅ">
            <el-option label="Â∑≤ÁîüÊïà" value="Â∑≤ÁîüÊïà" />
            <el-option label="Âç≥Â∞ÜÁîüÊïà" value="Âç≥Â∞ÜÁîüÊïà" />
            <el-option label="Â∑≤Â∫üÊ≠¢" value="Â∑≤Â∫üÊ≠¢" />
          </el-select>
        </el-form-item>
        <el-form-item label="ÈÄÇÁî®ËåÉÂõ¥" prop="scope">
          <el-input
            v-model="regulationForm.scope"
            placeholder="ËØ∑ËæìÂÖ•ÈÄÇÁî®ËåÉÂõ¥"
          />
        </el-form-item>
        <el-form-item label="Ê≥ïËßÑÂÜÖÂÆπ" prop="content">
          <el-input
            v-model="regulationForm.content"
            type="textarea"
            :rows="4"
            placeholder="ËØ∑ËæìÂÖ•Ê≥ïËßÑÂÜÖÂÆπ"
          />
        </el-form-item>
        <el-form-item label="ÂêàËßÑË¶ÅÊ±Ç" prop="requirements">
          <el-input
            v-model="regulationForm.requirements"
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•ÂêàËßÑË¶ÅÊ±ÇÔºåÁî®ÈÄóÂè∑ÂàÜÈöî"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showRegulationFormDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveRegulation">‰øùÂ≠ò</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- Ê∑ªÂä†/ÁºñËæëÊ£ÄÊü•Ê∏ÖÂçïÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showChecklistFormDialog"
      :title="isEditingChecklist ? 'ÁºñËæëÊ£ÄÊü•Ê∏ÖÂçï' : 'Ê∑ªÂä†Ê£ÄÊü•Ê∏ÖÂçï'"
      width="60%"
    >
      <el-form
        :model="checklistForm"
        :rules="checklistRules"
        ref="checklistFormRef"
        label-width="100px"
      >
        <el-form-item label="Ê£ÄÊü•È°πÁõÆ" prop="name">
          <el-input
            v-model="checklistForm.name"
            placeholder="ËØ∑ËæìÂÖ•Ê£ÄÊü•È°πÁõÆÂêçÁß∞"
          />
        </el-form-item>
        <el-form-item label="Á±ªÂà´" prop="category">
          <el-select v-model="checklistForm.category" placeholder="ÈÄâÊã©Á±ªÂà´">
            <el-option label="‰∏ìÂà©Áî≥ËØ∑" value="‰∏ìÂà©Áî≥ËØ∑" />
            <el-option label="Êï∞ÊçÆÂÆâÂÖ®" value="Êï∞ÊçÆÂÆâÂÖ®" />
            <el-option label="ÈöêÁßÅ‰øùÊä§" value="ÈöêÁßÅ‰øùÊä§" />
            <el-option label="Á≥ªÁªüÂÆâÂÖ®" value="Á≥ªÁªüÂÆâÂÖ®" />
          </el-select>
        </el-form-item>
        <el-form-item label="Êà™Ê≠¢Êó•Êúü" prop="dueDate">
          <el-date-picker
            v-model="checklistForm.dueDate"
            type="date"
            placeholder="ÈÄâÊã©Êà™Ê≠¢Êó•Êúü"
          />
        </el-form-item>
        <el-form-item label="Ë¥üË¥£‰∫∫" prop="assignee">
          <el-input
            v-model="checklistForm.assignee"
            placeholder="ËØ∑ËæìÂÖ•Ë¥üË¥£‰∫∫"
          />
        </el-form-item>
        <el-form-item label="‰ºòÂÖàÁ∫ß" prop="priority">
          <el-select v-model="checklistForm.priority" placeholder="ÈÄâÊã©‰ºòÂÖàÁ∫ß">
            <el-option label="È´ò" value="È´ò" />
            <el-option label="‰∏≠" value="‰∏≠" />
            <el-option label="‰Ωé" value="‰Ωé" />
          </el-select>
        </el-form-item>
        <el-form-item label="ÊèèËø∞" prop="description">
          <el-input
            v-model="checklistForm.description"
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•Ê£ÄÊü•ÊèèËø∞"
          />
        </el-form-item>
        <el-form-item label="Ê£ÄÊü•È°πÁõÆ" prop="items">
          <el-input
            v-model="checklistForm.items"
            type="textarea"
            :rows="4"
            placeholder="ËØ∑ËæìÂÖ•Ê£ÄÊü•È°πÁõÆÔºåÊØèË°å‰∏Ä‰∏™"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showChecklistFormDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveChecklistForm">‰øùÂ≠ò</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import { useComplianceStore } from "@/stores/compliance";
import {
  Document,
  Check,
  Monitor,
  Lock,
  Plus,
  Refresh,
  Download,
  Delete,
} from "@element-plus/icons-vue";

// ‰ΩøÁî®ÂêàËßÑÁÆ°ÁêÜÁä∂ÊÄÅ
const complianceStore = useComplianceStore();

// Ê¶ÇËßàÊï∞ÊçÆ
const overview = complianceStore.overview;

// Ê≥ïËßÑÊï∞ÊçÆ
const regulations = complianceStore.regulations;

// Ê£ÄÊü•Ê∏ÖÂçïÊï∞ÊçÆ
const checklists = complianceStore.checklists;

// ÂÆ°ËÆ°ÁóïËøπÊï∞ÊçÆ
const auditTrails = complianceStore.auditTrails;

// ÈöêÁßÅ‰∫ã‰ª∂Êï∞ÊçÆ
const privacyEvents = complianceStore.privacyEvents;

// ÂêàËßÑÁéáÊï∞ÊçÆ
const complianceRate = complianceStore.complianceRate;

// ÂØπËØùÊ°ÜÁõ∏ÂÖ≥
const showRegulationDialog = ref(false);
const showChecklistDialog = ref(false);
const showRegulationFormDialog = ref(false);
const showChecklistFormDialog = ref(false);
const selectedRegulation = ref(null);
const selectedChecklist = ref(null);
const isEditingRegulation = ref(false);
const isEditingChecklist = ref(false);

// Ë°®ÂçïÊï∞ÊçÆ
const regulationForm = reactive({
  name: "",
  version: "",
  publishDate: "",
  effectiveDate: "",
  status: "",
  scope: "",
  content: "",
  requirements: "",
});

const checklistForm = reactive({
  name: "",
  category: "",
  dueDate: "",
  assignee: "",
  priority: "",
  description: "",
  items: "",
});

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const regulationRules = {
  name: [{ required: true, message: "ËØ∑ËæìÂÖ•Ê≥ïËßÑÂêçÁß∞", trigger: "blur" }],
  version: [{ required: true, message: "ËØ∑ËæìÂÖ•ÁâàÊú¨Âè∑", trigger: "blur" }],
  status: [{ required: true, message: "ËØ∑ÈÄâÊã©Áä∂ÊÄÅ", trigger: "change" }],
};

const checklistRules = {
  name: [{ required: true, message: "ËØ∑ËæìÂÖ•Ê£ÄÊü•È°πÁõÆÂêçÁß∞", trigger: "blur" }],
  category: [{ required: true, message: "ËØ∑ÈÄâÊã©Á±ªÂà´", trigger: "change" }],
  dueDate: [{ required: true, message: "ËØ∑ÈÄâÊã©Êà™Ê≠¢Êó•Êúü", trigger: "change" }],
  assignee: [{ required: true, message: "ËØ∑ËæìÂÖ•Ë¥üË¥£‰∫∫", trigger: "blur" }],
};

// Ë°®ÂçïÂºïÁî®
const regulationFormRef = ref();
const checklistFormRef = ref();

// Ëé∑ÂèñÊ≥ïËßÑÁä∂ÊÄÅÁ±ªÂûã
const getRegulationStatusType = (status: string) => {
  switch (status) {
    case "Â∑≤ÁîüÊïà":
      return "success";
    case "Âç≥Â∞ÜÁîüÊïà":
      return "warning";
    case "Â∑≤Â∫üÊ≠¢":
      return "danger";
    default:
      return "info";
  }
};

// Ëé∑ÂèñÊ£ÄÊü•Ê∏ÖÂçïÁä∂ÊÄÅÁ±ªÂûã
const getChecklistStatusType = (status: string) => {
  switch (status) {
    case "Â∑≤ÂÆåÊàê":
      return "success";
    case "ËøõË°å‰∏≠":
      return "warning";
    case "ÂæÖÂºÄÂßã":
      return "info";
    case "Â∑≤ÈÄæÊúü":
      return "danger";
    default:
      return "info";
  }
};

// Ëé∑Âèñ‰∏•ÈáçÁ®ãÂ∫¶Á±ªÂûã
const getSeverityType = (severity: string) => {
  switch (severity) {
    case "È´ò":
      return "danger";
    case "‰∏≠":
      return "warning";
    case "‰Ωé":
      return "info";
    default:
      return "info";
  }
};

// Ëé∑ÂèñËøõÂ∫¶Êù°È¢úËâ≤
const getProgressColor = (percentage: number) => {
  if (percentage >= 80) return "#67c23a";
  if (percentage >= 60) return "#e6a23c";
  return "#f56c6c";
};

// Êü•ÁúãÊ≥ïËßÑËØ¶ÊÉÖ
const viewRegulation = (regulation: any) => {
  selectedRegulation.value = regulation;
  showRegulationDialog.value = true;
};

// ÁºñËæëÊ≥ïËßÑ
const editRegulation = (regulation: any) => {
  isEditingRegulation.value = true;
  Object.assign(regulationForm, regulation);
  showRegulationFormDialog.value = true;
};

// Ê∑ªÂä†Ê≥ïËßÑ
const addRegulation = () => {
  isEditingRegulation.value = false;
  Object.keys(regulationForm).forEach((key) => {
    regulationForm[key] = "";
  });
  showRegulationFormDialog.value = true;
};

// ‰øùÂ≠òÊ≥ïËßÑ
const saveRegulation = async () => {
  try {
    await regulationFormRef.value.validate();

    if (isEditingRegulation.value) {
      // ÁºñËæëÁé∞ÊúâÊ≥ïËßÑ
      await complianceStore.updateRegulation(
        selectedRegulation.value.id,
        regulationForm
      );
      ElMessage.success("Ê≥ïËßÑÊõ¥Êñ∞ÊàêÂäü");
    } else {
      // Ê∑ªÂä†Êñ∞Ê≥ïËßÑ
      await complianceStore.addRegulation(regulationForm);
      ElMessage.success("Ê≥ïËßÑÊ∑ªÂä†ÊàêÂäü");
    }

    showRegulationFormDialog.value = false;
  } catch (error) {
    ElMessage.error("ËØ∑Ê£ÄÊü•Ë°®Âçï‰ø°ÊÅØ");
  }
};

// Êü•ÁúãÊ£ÄÊü•Ê∏ÖÂçïËØ¶ÊÉÖ
const viewChecklist = (checklist: any) => {
  selectedChecklist.value = { ...checklist };
  showChecklistDialog.value = true;
};

// ÁºñËæëÊ£ÄÊü•Ê∏ÖÂçï
const editChecklist = (checklist: any) => {
  isEditingChecklist.value = true;
  Object.assign(checklistForm, {
    ...checklist,
    items: checklist.items.map((item) => item.description).join("\n"),
  });
  showChecklistFormDialog.value = true;
};

// Ê∑ªÂä†Ê£ÄÊü•Ê∏ÖÂçï
const addChecklist = () => {
  isEditingChecklist.value = false;
  Object.keys(checklistForm).forEach((key) => {
    checklistForm[key] = "";
  });
  showChecklistFormDialog.value = true;
};

// ‰øùÂ≠òÊ£ÄÊü•Ê∏ÖÂçïË°®Âçï
const saveChecklistForm = async () => {
  try {
    await checklistFormRef.value.validate();

    if (isEditingChecklist.value) {
      // ÁºñËæëÁé∞ÊúâÊ£ÄÊü•Ê∏ÖÂçï
      await complianceStore.updateChecklist(
        selectedChecklist.value.id,
        checklistForm
      );
      ElMessage.success("Ê£ÄÊü•Ê∏ÖÂçïÊõ¥Êñ∞ÊàêÂäü");
    } else {
      // Ê∑ªÂä†Êñ∞Ê£ÄÊü•Ê∏ÖÂçï
      await complianceStore.addChecklist(checklistForm);
      ElMessage.success("Ê£ÄÊü•Ê∏ÖÂçïÊ∑ªÂä†ÊàêÂäü");
    }

    showChecklistFormDialog.value = false;
  } catch (error) {
    ElMessage.error("ËØ∑Ê£ÄÊü•Ë°®Âçï‰ø°ÊÅØ");
  }
};

// Ê∑ªÂä†ÈöêÁßÅ‰∫ã‰ª∂
const addPrivacyEvent = () => {
  ElMessage.info("Ê∑ªÂä†ÈöêÁßÅ‰∫ã‰ª∂ÂäüËÉΩÂºÄÂèë‰∏≠");
};

// Âà∑Êñ∞Êï∞ÊçÆ
const refreshRegulations = () => {
  ElMessage.success("Ê≥ïËßÑÊï∞ÊçÆÂ∑≤Âà∑Êñ∞");
};

const refreshChecklists = () => {
  ElMessage.success("Ê£ÄÊü•Ê∏ÖÂçïÂ∑≤Âà∑Êñ∞");
};

const refreshAuditTrails = () => {
  ElMessage.success("ÂÆ°ËÆ°ÁóïËøπÂ∑≤Âà∑Êñ∞");
};

const refreshPrivacyEvents = () => {
  ElMessage.success("ÈöêÁßÅ‰∫ã‰ª∂Â∑≤Âà∑Êñ∞");
};

// ÂØºÂá∫ÂäüËÉΩ
const exportRegulations = () => {
  ElMessage.success("Ê≥ïËßÑÊï∞ÊçÆÂØºÂá∫ÊàêÂäü");
};

const exportChecklists = () => {
  ElMessage.success("Ê£ÄÊü•Ê∏ÖÂçïÂØºÂá∫ÊàêÂäü");
};

const exportAuditTrails = () => {
  ElMessage.success("ÂÆ°ËÆ°Êó•ÂøóÂØºÂá∫ÊàêÂäü");
};

const exportPrivacyEvents = () => {
  ElMessage.success("ÈöêÁßÅ‰∫ã‰ª∂ÂØºÂá∫ÊàêÂäü");
};

const clearAuditTrails = async () => {
  try {
    await ElMessageBox.confirm(
      "Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂÆ°ËÆ°ÁóïËøπÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ",
      "Á°ÆËÆ§Ê∏ÖÁ©∫",
      {
        type: "warning",
      }
    );
    await complianceStore.clearAuditTrails();
    ElMessage.success("ÂÆ°ËÆ°ÁóïËøπÂ∑≤Ê∏ÖÁ©∫");
  } catch (error) {
    // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
  }
};

const generateReport = () => {
  ElMessage.success("ÂêàËßÑÊä•ÂëäÁîüÊàêÊàêÂäü");
};

const exportReport = () => {
  ElMessage.success("ÂêàËßÑÊä•ÂëäÂØºÂá∫ÊàêÂäü");
};

// ‰øùÂ≠òÊ£ÄÊü•Ê∏ÖÂçï
const saveChecklist = () => {
  ElMessage.success("Ê£ÄÊü•Ê∏ÖÂçï‰øùÂ≠òÊàêÂäü");
  showChecklistDialog.value = false;
};

onMounted(async () => {
  console.log("ÂêàËßÑÁÆ°ÁêÜÈ°µÈù¢Â∑≤Âä†ËΩΩ");

  // Âä†ËΩΩÂêàËßÑÁÆ°ÁêÜÊï∞ÊçÆ
  try {
    await Promise.all([
      complianceStore.loadRegulations(),
      complianceStore.loadChecklists(),
      complianceStore.loadAuditTrails(),
      complianceStore.loadPrivacyEvents(),
    ]);
  } catch (error) {
    console.error("Âä†ËΩΩÂêàËßÑÁÆ°ÁêÜÊï∞ÊçÆÂ§±Ë¥•:", error);
    ElMessage.error("Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•");
  }
});
</script>

<style scoped>
.compliance-container {
  padding: 20px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.compliance-card {
  margin-bottom: 20px;
}

.card-header {
  text-align: center;
}

.card-header h2 {
  margin: 0;
  color: #303133;
  font-size: 24px;
}

.subtitle {
  margin: 10px 0 0 0;
  color: #909399;
  font-size: 14px;
}

.overview-section {
  margin-bottom: 20px;
}

.overview-card {
  height: 100%;
}

.overview-content {
  display: flex;
  align-items: center;
  padding: 20px;
}

.overview-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  color: white;
  font-size: 24px;
}

.overview-icon.regulations {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.overview-icon.checklist {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.overview-icon.audit {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.overview-icon.privacy {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.overview-info h3 {
  margin: 0 0 5px 0;
  font-size: 28px;
  color: #303133;
  font-weight: bold;
}

.overview-info p {
  margin: 0;
  color: #909399;
  font-size: 14px;
}

.modules-section {
  margin-bottom: 20px;
}

.module-card {
  height: 100%;
}

.module-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #303133;
}

.module-content {
  padding: 10px 0;
}

.module-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
}

.report-card {
  margin-bottom: 20px;
}

.report-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.report-header h3 {
  margin: 0;
  color: #303133;
}

.report-actions {
  display: flex;
  gap: 10px;
}

.report-content {
  padding: 20px 0;
}

.report-item {
  text-align: center;
  padding: 20px;
}

.report-item h4 {
  margin: 0 0 15px 0;
  color: #303133;
  font-size: 16px;
}

.progress-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

.progress-container span {
  font-weight: bold;
  color: #303133;
  min-width: 40px;
}

.regulation-detail,
.checklist-detail {
  padding: 20px 0;
}

.regulation-content,
.checklist-content {
  margin: 20px 0;
}

.regulation-content h4,
.checklist-content h4 {
  margin: 0 0 10px 0;
  color: #303133;
}

.regulation-content p,
.checklist-content p {
  margin: 0;
  color: #606266;
  line-height: 1.6;
}

.regulation-requirements,
.checklist-items {
  margin: 20px 0;
}

.regulation-requirements h4,
.checklist-items h4 {
  margin: 0 0 10px 0;
  color: #303133;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

:deep(.el-card__header) {
  background-color: #f8f9fa;
  border-bottom: 1px solid #ebeef5;
}

:deep(.el-progress) {
  flex: 1;
}
</style>
