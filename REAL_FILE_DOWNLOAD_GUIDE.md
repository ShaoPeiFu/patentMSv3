# 文件下载功能指南

## 概述

现在下载功能已经更新，支持下载用户实际上传的真实文件，而不是生成的模拟内容。

## 功能特性

### 📁 文件下载

- ✅ **支持真实文件**: 下载用户实际上传的文件
- ✅ **文件类型检测**: 自动检测文件类型和格式
- ✅ **文件大小显示**: 显示实际文件大小
- ✅ **上传时间记录**: 记录文件上传时间

### 🔧 文件上传功能

- ✅ **拖拽上传**: 支持拖拽文件到上传区域
- ✅ **多格式支持**: 支持 PDF、Word、图片等格式
- ✅ **文件验证**: 验证文件大小和类型
- ✅ **上传进度**: 显示文件上传进度

### 📋 文档管理

- ✅ **文档分类**: 按类型分类（申请文件、公开文件等）
- ✅ **文档删除**: 支持删除不需要的文档
- ✅ **批量下载**: 支持批量下载多个文档

## 使用方法

### 1. 上传文档

1. 进入专利详情页面
2. 点击"文档管理"卡片右上角的"上传文档"按钮
3. 在弹出的对话框中：
   - 选择文档类型（申请文件、公开文件等）
   - 输入文档名称
   - 选择要上传的文件
4. 点击"确认上传"按钮

### 2. 下载文档

1. **单个下载**: 点击文档行的"下载"按钮
2. **批量下载**: 点击"批量下载"按钮下载所有文档

### 3. 删除文档

1. 点击文档行的"删除"按钮
2. 确认删除操作

## 支持的文件格式

| 文件类型  | 扩展名            | 说明                       |
| --------- | ----------------- | -------------------------- |
| PDF 文档  | .pdf              | 专利申请说明书、授权证书等 |
| Word 文档 | .doc, .docx       | 专利申请文件、修改文件等   |
| 文本文件  | .txt              | 权利要求书、摘要等         |
| 图片文件  | .jpg, .jpeg, .png | 专利附图、照片等           |

## 文件大小限制

- **单个文件**: 最大 20MB
- **批量上传**: 最多 10 个文件
- **总存储**: 根据服务器配置

## 技术实现

### 下载逻辑

```typescript
// 检查是否有真实文件URL
if (document.fileUrl && document.fileUrl !== "/documents/") {
  // 下载真实文件
  await downloadRealFile(document, options);
} else {
  // 生成模拟文件内容（兼容旧数据）
  const content = generateFileContent(
    { ...patent, ...document },
    document.type
  );
  downloadFile(content, filename, options);
}
```

### 文件上传流程

1. **文件选择**: 用户选择文件
2. **文件验证**: 检查文件大小和类型
3. **上传处理**: 调用上传 API
4. **进度显示**: 显示上传进度
5. **成功回调**: 更新文档列表

### 真实文件下载

```typescript
export const downloadRealFile = async (
  document: any,
  options: DownloadOptions = {}
) => {
  const response = await fetch(document.fileUrl);
  const blob = await response.blob();
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = options.filename || document.name;
  link.click();
  URL.revokeObjectURL(url);
};
```

## 界面展示

### 文档管理表格

```
┌─────────────────┬──────────┬──────────┬────────────┬────────┐
│ 文档名称        │ 类型     │ 文件大小 │ 上传时间   │ 操作   │
├─────────────────┼──────────┼──────────┼────────────┼────────┤
│ 专利申请说明书  │ 申请文件 │ 1.2 MB  │ 2024/1/15  │ 下载   │
│ 专利附图        │ 其他文件 │ 856 KB  │ 2024/1/15  │ 下载   │
│ 权利要求书      │ 申请文件 │ 245 KB  │ 2024/1/15  │ 下载   │
└─────────────────┴──────────┴──────────┴────────────┴────────┘
```

### 上传对话框

```
┌─────────────────────────────────────┐
│ 上传专利文档                        │
├─────────────────────────────────────┤
│ 文档类型: [申请文件 ▼]              │
│ 文档名称: [专利申请说明书]          │
│ 文档文件: [拖拽或点击上传]          │
├─────────────────────────────────────┤
│ [取消] [确认上传]                   │
└─────────────────────────────────────┘
```

## 错误处理

### 常见问题

1. **文件上传失败**

   - 检查文件大小是否超过限制
   - 检查文件格式是否支持
   - 检查网络连接

2. **文件下载失败**

   - 检查文件是否存在
   - 检查文件 URL 是否有效
   - 检查浏览器下载设置

3. **文件删除失败**
   - 检查文件权限
   - 确认文件未被其他用户使用

### 解决方案

1. **重新上传**: 删除失败的文件，重新上传
2. **检查网络**: 确保网络连接正常
3. **清除缓存**: 清除浏览器缓存后重试
4. **联系管理员**: 如问题持续存在

## 数据存储

### 文档信息结构

```typescript
interface PatentDocument {
  id: number;
  patentId: number;
  name: string;
  type: "application" | "publication" | "grant" | "amendment" | "other";
  fileUrl: string; // 文件存储路径
  fileSize: number; // 文件大小（字节）
  uploadedAt: string; // 上传时间
  uploadedBy: number; // 上传用户ID
}
```

### 存储位置

- **文件存储**: 服务器文件系统或云存储
- **元数据存储**: 数据库或 localStorage
- **临时文件**: 浏览器临时存储

## 安全考虑

### 文件安全

- ✅ **文件类型验证**: 只允许特定格式的文件
- ✅ **文件大小限制**: 防止大文件攻击
- ✅ **文件内容检查**: 检查文件是否包含恶意代码
- ✅ **访问权限控制**: 只有授权用户可以下载

### 上传安全

- ✅ **文件扫描**: 扫描上传的文件
- ✅ **文件名清理**: 清理文件名中的特殊字符
- ✅ **存储隔离**: 不同用户的文件隔离存储

## 性能优化

### 下载优化

- ✅ **分块下载**: 大文件分块下载
- ✅ **断点续传**: 支持断点续传功能
- ✅ **缓存机制**: 缓存常用文件

### 上传优化

- ✅ **压缩上传**: 自动压缩大文件
- ✅ **进度显示**: 实时显示上传进度
- ✅ **并发控制**: 控制同时上传的文件数量

## 扩展功能

### 未来计划

1. **在线预览**: 支持文档在线预览
2. **版本控制**: 支持文档版本管理
3. **文件加密**: 支持文件加密存储
4. **云存储集成**: 集成阿里云、腾讯云等

### 集成建议

1. **后端 API**: 实现完整的文件上传 API
2. **文件服务**: 使用专门的文件存储服务
3. **CDN 加速**: 使用 CDN 加速文件下载
4. **备份策略**: 实现文件备份和恢复

---

**版本**: 2.0.0  
**最后更新**: 2024 年 7 月 30 日  
**维护者**: 新浪科技开发团队
